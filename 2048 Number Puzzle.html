<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>2048 Puzzle Game - Feature Rich</title>
<style>
body {
    margin:0;
    background:#faf8ef;
    display:flex;
    justify-content:center;
    align-items:center;
    height:100vh;
    font-family:Arial,sans-serif;
    flex-direction:column;
    transition:0.3s;
}
#controls {
    margin-bottom:10px;
}
button{
    padding:8px 15px;
    margin:0 5px;
    cursor:pointer;
}
#score-board, #move-count { margin:5px; font-weight:bold; }
#game-container {
    background: #bbada0;
    padding: 15px;
    border-radius: 10px;
    display: grid;
    grid-template-columns: repeat(4, 100px);
    grid-gap: 15px;
    touch-action: none;
    position:relative;
}
.tile {
    width: 100px;
    height: 100px;
    background: #cdc1b4;
    border-radius: 5px;
    display: flex;
    justify-content:center;
    align-items:center;
    font-size:45px;
    font-weight:bold;
    color:#776e65;
    transition:0.2s all;
    box-shadow:2px 2px 5px rgba(0,0,0,0.2);
}
.tile-2 { background:#eee4da; }
.tile-4 { background:#ede0c8; }
.tile-8 { background:#f2b179; color:#f9f6f2; }
.tile-16 { background:#f59563; color:#f9f6f2; }
.tile-32 { background:#f67c5f; color:#f9f6f2; }
.tile-64 { background:#f65e3b; color:#f9f6f2; }
.tile-128 { background:#edcf72; color:#f9f6f2; font-size:35px; }
.tile-256 { background:#edcc61; color:#f9f6f2; font-size:35px; }
.tile-512 { background:#edc850; color:#f9f6f2; font-size:35px; }
.tile-1024 { background:#edc53f; color:#f9f6f2; font-size:30px; }
.tile-2048 { background:#edc22e; color:#f9f6f2; font-size:30px; }
.dark-mode { background:#2b2b2b; color:#f5f5f5; }
</style>
</head>
<body>
<div id="controls">
    <button onclick="restartGame()">Restart</button>
    <button onclick="undoMove()">Undo</button>
    <button onclick="toggleDarkMode()">Dark Mode</button>
</div>
<div id="score-board">Score: 0 | High Score: 0</div>
<div id="move-count">Moves: 0</div>
<audio id="bgMusic" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3" loop autoplay></audio>
<audio id="mergeSound" src="https://www.soundjay.com/button/beep-07.wav"></audio>

<div id="game-container"></div>

<script>
const size=4;
let board=[];
let prevBoard=[];
let score=0, highScore=localStorage.getItem('highScore')||0;
let moves=0;
const container=document.getElementById('game-container');
const scoreBoard=document.getElementById('score-board');
const moveCount=document.getElementById('move-count');
const mergeSound=document.getElementById('mergeSound');

function initBoard(){
    board=Array(size).fill().map(()=>Array(size).fill(0));
    score=0; moves=0;
    addRandomTile(); addRandomTile(); drawBoard(); updateScore();
}

function drawBoard(){
    container.innerHTML='';
    for(let i=0;i<size;i++){
        for(let j=0;j<size;j++){
            const tile=document.createElement('div');
            tile.classList.add('tile');
            if(board[i][j]!==0) tile.classList.add('tile-'+board[i][j]);
            tile.textContent=board[i][j]===0?'':board[i][j];
            container.appendChild(tile);
        }
    }
    updateScore();
}

function addRandomTile(){
    let empty=[];
    for(let i=0;i<size;i++){
        for(let j=0;j<size;j++){
            if(board[i][j]===0) empty.push({i,j});
        }
    }
    if(empty.length===0) return;
    const {i,j}=empty[Math.floor(Math.random()*empty.length)];
    board[i][j]=Math.random()<0.9?2:4;
}

function slide(row){
    let arr=row.filter(val=>val);
    for(let i=0;i<arr.length-1;i++){
        if(arr[i]===arr[i+1]){
            arr[i]*=2;
            arr[i+1]=0;
            score+=arr[i];
            mergeSound.play();
        }
    }
    arr=arr.filter(val=>val);
    while(arr.length<size) arr.push(0);
    return arr;
}

function rotateClockwise(mat){
    let res=[];
    for(let i=0;i<size;i++){
        res[i]=[];
        for(let j=0;j<size;j++){
            res[i][j]=mat[size-j-1][i];
        }
    }
    return res;
}

function savePrevBoard(){ prevBoard=board.map(row=>row.slice()); }

function moveLeft(){
    savePrevBoard(); let moved=false;
    for(let i=0;i<size;i++){
        let newRow=slide(board[i]);
        if(newRow.toString()!==board[i].toString()) moved=true;
        board[i]=newRow;
    }
    if(moved){ addRandomTile(); moves++; drawBoard(); checkGameOver(); }
}

function moveRight(){ board=board.map(row=>row.reverse()); moveLeft(); board=board.map(row=>row.reverse()); }
function moveUp(){ board=rotateClockwise(board); moveLeft(); board=rotateClockwise(rotateClockwise(rotateClockwise(board))); }
function moveDown(){ board=rotateClockwise(rotateClockwise(rotateClockwise(board))); moveLeft(); board=rotateClockwise(board); }

document.addEventListener('keydown',e=>{
    if(e.key==='ArrowLeft') moveLeft();
    if(e.key==='ArrowRight') moveRight();
    if(e.key==='ArrowUp') moveUp();
    if(e.key==='ArrowDown') moveDown();
});

// Mobile swipe
let startX=0,startY=0;
container.addEventListener('touchstart',e=>{ startX=e.touches[0].clientX; startY=e.touches[0].clientY; });
container.addEventListener('touchend',e=>{
    let dx=e.changedTouches[0].clientX-startX;
    let dy=e.changedTouches[0].clientY-startY;
    if(Math.abs(dx)>Math.abs(dy)){
        if(dx>30) moveRight(); else if(dx<-30) moveLeft();
    }else{
        if(dy>30) moveDown(); else if(dy<-30) moveUp();
    }
});

function updateScore(){
    if(score>highScore){ highScore=score; localStorage.setItem('highScore',highScore);}
    scoreBoard.textContent=`Score: ${score} | High Score: ${highScore}`;
    moveCount.textContent=`Moves: ${moves}`;
}

function checkGameOver(){
    for(let i=0;i<size;i++){
        for(let j=0;j<size;j++){
            if(board[i][j]===0) return;
            if(j<size-1 && board[i][j]===board[i][j+1]) return;
            if(i<size-1 && board[i][j]===board[i+1][j]) return;
        }
    }
    setTimeout(()=>{ alert("Game Over!"); initBoard(); },100);
}

function undoMove(){ if(prevBoard.length>0){ board=prevBoard.map(row=>row.slice()); drawBoard(); moves--; } }
function restartGame(){ initBoard(); }
function toggleDarkMode(){ document.body.classList.toggle('dark-mode'); }

initBoard();
</script>
</body>
</html>
